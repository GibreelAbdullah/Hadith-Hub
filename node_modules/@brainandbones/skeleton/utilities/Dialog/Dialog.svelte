<!-- Source: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/dialog -->
<script>import { fade, scale } from 'svelte/transition';
import { dialogStore } from './stores';
// Props
export let backdrop = 'bg-backdrop-token';
export let blur = 'backdrop-blur-xs';
export let background = 'bg-surface-200-700-token';
export let width = 'max-w-[640px]';
export let duration = 100;
// Local Settings
let elemModal;
let dialogValue;
// Base Classes
const cBaseBackdrop = 'fixed top-0 left-0 right-0 bottom-0 z-[999] flex justify-center items-center p-4';
const cBaseDialog = 'p-4 w-full space-y-4 rounded-xl drop-shadow';
const cBaseHeader = 'flex justify-start items-center space-x-4';
const cBaseIcon = 'fill-black dark:fill-white bg-primary-500/20 flex justify-center items-center w-10 mx-auto aspect-square rounded-full';
const cBaseImage = 'w-full h-auto rounded-lg';
const cBaseFooter = 'flex justify-end space-x-4';
// Set the Result value response based on button selection
function setResult(v) {
    if ($dialogStore[0].result) {
        $dialogStore[0].result(v);
    }
}
// Click Handlers
function onDialogClose() {
    setResult(false);
    dialogStore.close();
}
function onDialogConfirmSubmit() {
    setResult(true);
    dialogStore.close();
}
function onDialogPromptSubmit() {
    setResult(dialogValue);
    dialogStore.close();
}
// Subscribe to dialog updates
dialogStore.subscribe((dArr) => {
    // Dialog quey updated and includes a value
    if (dArr.length) {
        // Focus on first valid modal element
        setTimeout(() => {
            if (elemModal !== null) {
                const elemWhitelist = 'a[href], button, input, textarea, select, details, [tabindex]:not([tabindex="-1"])';
                const focusableElems = elemModal.querySelectorAll(elemWhitelist);
                if (focusableElems !== null) {
                    focusableElems[0].focus();
                }
            }
        }, 100);
        // firstFooterButton.focus();
        // Set the local dialog value (for prompt)
        dialogValue = dArr[0].value;
    }
});
// A11y Input Handler
function onKeyPress(event) {
    // ESC to close dialog
    if (event.code === 'Escape') {
        onDialogClose();
    }
}
// Reactive Classes
$: classesBackdrop = `${cBaseBackdrop} ${backdrop} ${blur}`;
$: classesDialog = `${cBaseDialog} ${background} ${width}`;
</script>

{#if $dialogStore.length}
	<!-- Backdrop Shim -->
	<div class="dialog-backdrop {classesBackdrop} {$$props.class ?? ''}" on:click={onDialogClose} on:keydown={onKeyPress} transition:fade|local={{ duration }} data-testid="dialog-backdrop">
		<!-- Dialog -->
		<div
			bind:this={elemModal}
			class="dialog {classesDialog}"
			on:click|preventDefault|stopPropagation
			transition:scale|local={{ duration, opacity: 0, start: 0.5 }}
			data-testid="dialog"
			role="dialog"
			aria-modal="true"
			aria-label={$dialogStore[0].title}
		>
			<!-- Header -->
			<header class="dialog-header {cBaseHeader}">
				<!-- Icon -->
				{#if $dialogStore[0].icon}
					<div class="dialog-icon {cBaseIcon}">{@html $dialogStore[0].icon}</div>
				{/if}

				<!-- Title -->
				<span class="dialog-title flex-1 text-xl font-bold">{@html $dialogStore[0].title}</span>
			</header>

			<!-- Content -->
			<section class="dialog-content space-y-4">
				<!-- Body -->
				<div class="dialog-body">
					{@html $dialogStore[0].body}
				</div>

				<!-- If: image -->
				{#if $dialogStore[0].image}
					<img src={$dialogStore[0].image} class="dialog-image {cBaseImage}" alt="Dialog" loading="lazy" />
				{/if}

				<!-- If: HTML -->
				{#if $dialogStore[0].html}
					<div class="dialog-html">
						{@html $dialogStore[0].html}
					</div>
				{/if}

				<!-- If: Component -->
				<!-- {#if $dialogStore[0].component}
					<svelte:component this={$dialogStore[0].component.element} {...$dialogStore[0].component.props}>
						{@html $dialogStore[0].component.slot}
					</svelte:component>
				{/if} -->

				<!-- If: Prompt -->
				{#if $dialogStore[0].type === 'prompt'}
					<input class="dialog-prompt-input" type="text" bind:value={dialogValue} placeholder="Enter value..." required />
				{/if}
			</section>

			<!-- Actions -->
			<footer class="dialog-actions {cBaseFooter}">
				<!-- Button: Cancel -->
				<button class="btn btn-ghost" on:click={onDialogClose}>Close</button>
				<!-- If Confirm - button: Confirm -->
				{#if $dialogStore[0].type === 'confirm'}<button class="btn btn-filled-primary" on:click={onDialogConfirmSubmit}>Confirm</button>{/if}
				<!-- If Promopt - button: Submit -->
				{#if $dialogStore[0].type === 'prompt'}<button class="btn btn-filled-primary" on:click={onDialogPromptSubmit}>Submit</button>{/if}
			</footer>
		</div>
	</div>
{/if}
